<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRM de Carros PME</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent-2:#60a5fa; --danger:#ef4444; --warn:#f59e0b; --card:#0b1220; --chip:#1f2937; --border:#1f2937; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;background:linear-gradient(180deg,#0b1220,#0f172a 30%,#0b1220 100%);color:var(--text)}
    header{padding:20px;border-bottom:1px solid var(--border);background:rgba(15,23,42,.7);position:sticky;top:0;backdrop-filter:blur(8px);z-index:5}
    h1{margin:0;font-size:20px;font-weight:700}
    .wrap{max-width:1250px;margin:20px auto;padding:0 16px;display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .card{background:linear-gradient(180deg,var(--card),#0e1628);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .card h2{font-size:18px;margin:0 0 12px;display:flex;align-items:center;gap:8px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--accent-2);box-shadow:0 0 0 3px rgba(96,165,250,.15)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:var(--accent-2);color:#071120;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;transition:transform .05s ease}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#1f2937;color:var(--text);border:1px solid var(--border)}
    .btn.success{background:var(--accent);color:#072012}
    .btn.warn{background:var(--warn);color:#201807}
    .btn.danger{background:var(--danger);color:#200707}
    .list{display:grid;gap:10px;margin-top:10px}
    .item{border:1px solid var(--border);border-radius:12px;padding:10px;background:linear-gradient(180deg,#0e1628,#0b1220);display:grid;gap:8px}
    .item .head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .muted{color:var(--muted);font-size:12px}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{background:var(--chip);color:#cbd5e1;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border)}
    .matches{margin-top:6px;font-size:13px}
    @media (max-width:1100px){.wrap{grid-template-columns:1fr}}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;padding:0 6px;border:1px solid var(--border);border-bottom-width:2px;border-radius:6px;font-size:12px;color:#cbd5e1;background:#0a1020}
    .thumbs{display:flex;gap:6px;flex-wrap:wrap}
    .thumb{width:74px;height:74px;border-radius:8px;border:1px solid var(--border);object-fit:cover}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .stats{display:flex;gap:16px;font-size:12px;color:#cbd5e1;margin-top:6px}
    .search{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,.85);backdrop-filter:blur(6px);z-index:1000}
    .login-card{background:linear-gradient(180deg,var(--card),#0e1628);border:1px solid var(--border);border-radius:16px;padding:20px;width:100%;max-width:420px;box-shadow:0 10px 40px rgba(0,0,0,.45)}
    .login-card h2{margin:0 0 12px;font-size:18px}
    .login-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <!-- Login fixo -->
  <div id="loginView" class="overlay">
    <div class="login-card">
      <h2>üîê Acesso</h2>
      <label>Usu√°rio (fixo)</label><input id="lgUser"/>
      <label>Senha</label><input id="lgPass" type="password"/>
      <div class="login-actions">
        <button class="btn success" id="btnLogin">Entrar</button>
      </div>
      <div class="note">Usu√°rio √© validado no c√≥digo. Senha inicial: <code>padrao1234</code> (o usu√°rio pode troc√°-la depois em <em>Conta</em>).</div>
    </div>
  </div>

  <div id="app" style="display:none">
    <header>
      <div class="row" style="justify-content:space-between;align-items:center">
        <h1>üìá CRM de Carros PME</h1>
        <div class="row">
          <button class="btn secondary" id="btnAccount">Conta</button>
          <button class="btn" id="btnLogout">Sair</button>
        </div>
      </div>
    </header>

    <div class="wrap">
      <!-- CLIENTES -->
      <section class="card">
        <h2>üë§ Cadastrar cliente</h2>
        <div class="grid-2">
          <div><label>Nome*</label><input id="cliNome" placeholder="Ex: Ana Lima"/></div>
          <div><label>WhatsApp* (DDI 55 + DDD + n√∫mero ‚Äî s√≥ d√≠gitos)</label><input id="cliZap" placeholder="Ex: 5514997007069"/></div>
        </div>
        <div class="grid-3" style="margin-top:10px">
          <div><label>Marca (ex: Toyota)</label><input id="cliMarca"/></div>
          <div><label>Modelo (palavra-chave, ex: Etios)</label><input id="cliModelo"/></div>
          <div><label>Tipo</label>
            <select id="cliTipo"><option value="">Indiferente</option><option>Sedan</option><option>Hatch</option><option>SUV</option><option>Picape</option><option>Perua</option><option>Van</option></select>
          </div>
        </div>
        <div class="grid-3" style="margin-top:10px">
          <div><label>Ano m√≠n.</label><input id="cliAnoMin" type="number" min="1980" max="2100" placeholder="Ex: 2015"/></div>
          <div><label>Ano m√°x.</label><input id="cliAnoMax" type="number" min="1980" max="2100" placeholder="Ex: 2020"/></div>
          <div><label>Pre√ßo m√°x. (R$)</label><input id="cliPrecoMax" type="number" min="0" step="500" placeholder="Ex: 50000"/></div>
        </div>
        <div class="row" style="margin-top:8px">
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="cliJaComprou"/> J√° comprou (n√£o enviar mensagens)
          </label>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn success" id="btnAddCliente">Salvar cliente</button>
          <button class="btn secondary" id="btnLimparCliente">Limpar</button>
        </div>

        <div class="toolbar" style="margin-top:16px">
          <button class="btn danger" id="btnApagarClientes" title="Apaga TODOS os clientes">Apagar clientes</button>
        </div>

        <div class="search">
          <input id="buscaCliente" placeholder="Buscar cliente por nome/WhatsApp" />
        </div>

        <div class="stats" id="statsClientes"></div>
        <h3 style="margin:10px 0 8px">Clientes salvos</h3>
        <div id="listaClientes" class="list"></div>
      </section>

      <!-- CARROS -->
      <section class="card">
        <h2>üöò Cadastrar carro no estoque</h2>
        <div class="grid-3">
          <div><label>Marca*</label><input id="carMarca" placeholder="Ex: Toyota"/></div>
          <div><label>Modelo*</label><input id="carModelo" placeholder="Ex: Etios 1.5 XS"/></div>
          <div><label>Tipo</label>
            <select id="carTipo"><option>Sedan</option><option>Hatch</option><option>SUV</option><option>Picape</option><option>Perua</option><option>Van</option></select>
          </div>
        </div>
        <div class="grid-3" style="margin-top:10px">
          <div><label>Ano</label><input id="carAno" type="number" min="1980" max="2100" placeholder="Ex: 2017"/></div>
          <div><label>Pre√ßo (R$)</label><input id="carPreco" type="number" min="0" step="500" placeholder="Ex: 49000"/></div>
          <div><label>Link/ID interno (opcional)</label><input id="carLink" placeholder="Ex: URL do an√∫ncio"/></div>
        </div>
        <div style="margin-top:10px">
          <label>Fotos (at√© 10)
            <span class="muted">‚Ä¢ As fotos ficam salvas no navegador (IndexedDB). N√£o s√£o enviadas para nenhum servidor.</span>
          </label>
          <input id="carFotos" type="file" accept="image/*" multiple />
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn success" id="btnAddCarro">Salvar carro</button>
          <button class="btn secondary" id="btnLimparCarro">Limpar</button>
        </div>

        <div class="toolbar" style="margin-top:16px">
          <button class="btn danger" id="btnApagarCarros" title="Apaga TODOS os carros">Apagar carros</button>
        </div>

        <div class="search">
          <input id="buscaCarro" placeholder="Buscar por marca/modelo" />
          <input id="fPrecoMax" type="number" placeholder="Pre√ßo max" style="max-width:140px"/>
          <select id="fTipo" style="max-width:140px"><option value="">Tipo</option><option>Sedan</option><option>Hatch</option><option>SUV</option><option>Picape</option><option>Perua</option><option>Van</option></select>
        </div>

        <div class="stats" id="statsCarros"></div>
        <h3 style="margin:10px 0 8px">Estoque</h3>
        <div class="muted">Ao salvar um carro, o sistema encontra clientes compat√≠veis. Use ‚ÄúWhatsApp (texto)‚Äù ou ‚ÄúCompartilhar c/ fotos‚Äù.</div>
        <div id="listaCarros" class="list"></div>
      </section>
    </div>

    <!-- BACKUP GLOBAL: EXCEL + FOTOS ZIP -->
    <div class="wrap" style="margin-top:0">
      <section class="card" style="grid-column: 1 / -1;">
        <h2>üíæ Backup</h2>
        <div class="toolbar">
          <button class="btn warn" id="btnExportExcel">Exportar Excel (Clientes + Carros)</button>
          <label class="btn warn" for="impExcel">Importar Excel (substitui tudo)</label>
          <input id="impExcel" type="file" accept=".xlsx,.xls" style="display:none" />
          <button class="btn secondary" id="btnZipFotos">Exportar todas as FOTOS (.zip)</button>
          <label class="btn secondary" for="impZipFotos">Importar FOTOS (.zip exportado aqui)</label>
          <input id="impZipFotos" type="file" accept=".zip" style="display:none" />
        </div>
        <div class="muted" style="margin-top:8px">O Excel n√£o inclui imagens. Use tamb√©m o <strong>.zip de fotos</strong> para backup completo.</div>
      </section>
    </div>

    <div class="wrap" style="margin-top:0">
      <!-- <section class="card" style="grid-column: 1 / -1;">
        <h2>‚ÑπÔ∏è Envio por WhatsApp com fotos (sem backend)</h2>
        <div class="muted">‚Ä¢ ‚ÄúWhatsApp (texto)‚Äù abre o chat com mensagem pronta. ‚Ä¢ Para anexar fotos, use ‚ÄúCompartilhar c/ fotos‚Äù no celular (Web Share API).</div>
      </section> -->
    </div>
  </div>

  <!-- Modal de Conta (alterar senha) -->
  <div id="accountModal" class="overlay" style="display:none">
    <div class="login-card">
      <h2>‚öôÔ∏è Conta</h2>
      <div class="muted">Usu√°rio (fixo): <strong id="accountUser"></strong></div>
      <label>Senha atual</label><input id="pwCur" type="password"/>
      <label>Nova senha</label><input id="pwNew" type="password"/>
      <label>Confirmar nova senha</label><input id="pwNew2" type="password"/>
      <div class="login-actions">
        <button class="btn success" id="btnChangePw">Alterar senha</button>
        <button class="btn secondary" id="btnCloseAccount">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG LICENCIAMENTO (ajuste aqui por cliente) ======
    const ALLOWED_USER = "SUA_LOJA_AQUI"; // <-- Troque pelo usu√°rio do cliente (ex.: "loja_souza").
    const DEFAULT_PASSWORD = "padrao1234"; // senha inicial; o cliente poder√° mudar em Conta.

    // ====== Util ======
    const el = (sel) => document.querySelector(sel);
    const enc = (s) => encodeURIComponent(String(s || ''));
    const numOrNull = (v) => { const n = Number(v); return Number.isFinite(n) ? n : null; };
    const telLimpo = (s) => String(s || '').replace(/\D+/g,'');
    function toBool(v){ if (typeof v === 'boolean') return v; const s=String(v).trim().toLowerCase(); return s==='1'||s==='true'||s==='sim'||s==='yes'||s==='y'||s==='ok'||s==='x'; }
    const nowTS = () => new Date().toISOString().replace(/[:T]/g,'-').split('.')[0];
    const uuid = () => (crypto?.randomUUID ? crypto.randomUUID() : 'id-' + Math.random().toString(36).slice(2));

    // ====== Auth (frontend) ======
    const AUTH_KEY='crm_auth_v6';
    const SESSION_KEY='crm_session_v6';
    function hex(buf){return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');}
    async function sha256Hex(str){ const enc = new TextEncoder().encode(str); const d= await crypto.subtle.digest('SHA-256', enc); return hex(d); }
    function randomHex(n=16){ const a=new Uint8Array(n); crypto.getRandomValues(a); return [...a].map(b=>b.toString(16).padStart(2,'0')).join(''); }
    function getAuth(){ try{ return JSON.parse(localStorage.getItem(AUTH_KEY)||''); }catch(e){ return null; } }
    function setAuth(obj){ localStorage.setItem(AUTH_KEY, JSON.stringify(obj)); }
    function isLogged(){ return !!sessionStorage.getItem(SESSION_KEY); }
    function setLogged(){ sessionStorage.setItem(SESSION_KEY, String(Date.now())); }
    function showApp(){ document.getElementById('loginView').style.display='none'; document.getElementById('app').style.display='block'; }
    function showLogin(){ document.getElementById('loginView').style.display='flex'; document.getElementById('app').style.display='none'; }

    async function ensureDefaultAuth(){
      let auth = getAuth();
      if (!auth){
        const salt = randomHex(16);
        const hash = await sha256Hex(salt+':'+DEFAULT_PASSWORD);
        auth = { user: ALLOWED_USER, salt, hash, createdAt: Date.now() };
        setAuth(auth);
      } else {
        // se algu√©m tentar trocar o usu√°rio no storage, repara
        if (auth.user !== ALLOWED_USER){ auth.user = ALLOWED_USER; setAuth(auth); }
      }
    }
    async function initAuthUI(){
      await ensureDefaultAuth();
      const u = document.getElementById('lgUser');
      u.value = ALLOWED_USER; // mostra o usu√°rio fixo
      u.readOnly = false; // deixa digitar, mas vamos validar no login

      const btnLogin = document.getElementById('btnLogin');
      if (btnLogin) btnLogin.onclick = async ()=>{
        const typedUser = document.getElementById('lgUser').value.trim();
        const pass = document.getElementById('lgPass').value;
        if (typedUser !== ALLOWED_USER){ alert('Usu√°rio n√£o autorizado.'); return; }
        const auth = getAuth();
        const hash = await sha256Hex(auth.salt+':'+pass);
        if (hash!==auth.hash){ alert('Senha incorreta.'); return; }
        setLogged(); showApp();
      };
      if (isLogged()) showApp(); else showLogin();
    }

    // Conta (alterar senha, logout)
    function openAccount(){
      const auth = getAuth(); if (!auth){ alert('Conta inv√°lida.'); return; }
      document.getElementById('accountUser').textContent = ALLOWED_USER;
      document.getElementById('pwCur').value='';
      document.getElementById('pwNew').value='';
      document.getElementById('pwNew2').value='';
      document.getElementById('accountModal').style.display='flex';
    }
    function closeAccount(){ document.getElementById('accountModal').style.display='none'; }
    async function changePassword(){
      const auth = getAuth(); if (!auth) return;
      const cur = document.getElementById('pwCur').value;
      const n1 = document.getElementById('pwNew').value;
      const n2 = document.getElementById('pwNew2').value;
      const hashCur = await sha256Hex(auth.salt+':'+cur);
      if (hashCur !== auth.hash){ alert('Senha atual incorreta.'); return; }
      if (!n1 || n1.length < 4){ alert('Nova senha muito curta.'); return; }
      if (n1 !== n2){ alert('Nova senha e confirma√ß√£o n√£o conferem.'); return; }
      const salt = randomHex(16); const hash = await sha256Hex(salt+':'+n1);
      setAuth({user: ALLOWED_USER, salt, hash});
      alert('Senha alterada.'); closeAccount();
    }
    function bindAccountUI(){
      const btnAccount = document.getElementById('btnAccount');
      const btnLogout = document.getElementById('btnLogout');
      const btnClose = document.getElementById('btnCloseAccount');
      const btnChange = document.getElementById('btnChangePw');
      if (btnAccount) btnAccount.onclick = openAccount;
      if (btnLogout) btnLogout.onclick = ()=>{ sessionStorage.removeItem(SESSION_KEY); showLogin(); };
      if (btnClose) btnClose.onclick = closeAccount;
      if (btnChange) btnChange.onclick = changePassword;
    }

    // ====== Persist√™ncia ======
    const KEYS = { clientes: 'crm_clientes_v6', carros: 'crm_carros_v6' };
    const read = (k) => JSON.parse(localStorage.getItem(k) || '[]');
    const write = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    let clientes = read(KEYS.clientes);
    let carros = read(KEYS.carros);
    carros.forEach(c => { if (!c.id) c.id = uuid(); }); write(KEYS.carros, carros);

    // ====== IndexedDB para fotos ======
    const DB_NAME = 'crm_carros_db_v6';
    const DB_VER = 1; let _db;
    function openDB(){ return new Promise((resolve, reject)=>{ const req = indexedDB.open(DB_NAME, DB_VER); req.onupgradeneeded = (e)=>{ const db = e.target.result; if (!db.objectStoreNames.contains('photos')){ const store = db.createObjectStore('photos', {keyPath:'id'}); store.createIndex('carId', 'carId', {unique:false}); } }; req.onsuccess = ()=>{ _db = req.result; resolve(_db); }; req.onerror = ()=> reject(req.error); }); }
    async function db(){ return _db || await openDB(); }
    async function addPhotos(carId, files){ const dbi = await db(); const tx = dbi.transaction('photos','readwrite'); const store = tx.objectStore('photos'); const added = []; for (const file of files){ const id = uuid(); const rec = { id, carId, name: file.name, type: file.type, size: file.size, createdAt: Date.now(), blob: file }; store.put(rec); added.push(rec);} return added; }
    async function getPhotosByCar(carId){ const dbi = await db(); const tx = dbi.transaction('photos','readonly'); const idx = tx.objectStore('photos').index('carId'); return new Promise((resolve, reject)=>{ const req = idx.getAll(carId); req.onsuccess = ()=> resolve(req.result || []); req.onerror = ()=> reject(req.error); }); }
    async function deletePhoto(photoId){ const dbi = await db(); const tx = dbi.transaction('photos','readwrite'); tx.objectStore('photos').delete(photoId); return new Promise((resolve)=>{ tx.oncomplete = ()=> resolve(true); }); }
    function blobUrl(b){ return URL.createObjectURL(b); }

    // ====== Matching ======
    function compat√≠vel(c, car){ const eq=(a,b)=>String(a||'').toLowerCase()===String(b||'').toLowerCase(); const contains=(hay,needle)=>String(hay||'').toLowerCase().includes(String(needle||'').toLowerCase()); if (c.marca && !eq(c.marca, car.marca)) return false; if (c.modelo && !contains(car.modelo, c.modelo)) return false; if (c.tipo && !eq(c.tipo, car.tipo)) return false; if (c.anoMin && car.ano && Number(car.ano) < Number(c.anoMin)) return false; if (c.anoMax && car.ano && Number(car.ano) > Number(c.anoMax)) return false; if (c.precoMax && car.preco && Number(car.preco) > Number(c.precoMax)) return false; return true; }
    function msgPadrao(car, cliente){ const preco = car.preco ? ` por R$ ${Number(car.preco).toLocaleString('pt-BR')}` : ''; const link = car.link ? `\nüîó Detalhes: ${car.link}` : ''; return `Ol√°, ${cliente.nome}! üòä\n` + `Chegou ${car.marca} ${car.modelo} ${car.ano || ''}${preco} na nossa loja.\n` + `Vi que voc√™ tem interesse nesse perfil. Quer agendar uma visita ou fotos/v√≠deo?${link}\n\n` + `‚Äî Equipe de Vendas`; }
    function waLink(phone, text){ return `https://wa.me/${telLimpo(phone)}?text=${enc(text)}`; }

    // ====== Valida√ß√µes ======
    function validaZapBR(z){ const t = telLimpo(z); return /^55\d{10,11}$/.test(t); }
    function clienteDuplicado(whats){ const t = telLimpo(whats); return clientes.findIndex(c => telLimpo(c.zap) === t); }
    function carroDuplicado(car){ return carros.findIndex(c => c.marca?.toLowerCase() === car.marca?.toLowerCase() && c.modelo?.toLowerCase() === car.modelo?.toLowerCase() && (c.ano||'') === (car.ano||'') && (c.preco||'') === (car.preco||'')); }

    // ====== Render ======
    function renderStats(){ const ativos = clientes.filter(c=>!c.jaComprou).length; const compr = clientes.length - ativos; el('#statsClientes').textContent = `${clientes.length} cliente(s) ‚Ä¢ ${ativos} ativos ‚Ä¢ ${compr} j√° compraram`; el('#statsCarros').textContent = `${carros.length} carro(s) no estoque`; }
    function renderClientes(){ const box = el('#listaClientes'); const q = (el('#buscaCliente').value||'').toLowerCase().trim(); const list = clientes.filter(c=> !q || c.nome?.toLowerCase().includes(q) || telLimpo(c.zap).includes(q.replace(/\D+/g,'')) ); if (!list.length){ box.innerHTML = `<div class="muted">Nenhum cliente.</div>`; renderStats(); return; } box.innerHTML = list.map((c)=>{ const i = clientes.indexOf(c); const chips = []; if (c.marca) chips.push(`<span class="chip">Marca: ${c.marca}</span>`); if (c.modelo) chips.push(`<span class="chip">Modelo: ${c.modelo}</span>`); if (c.tipo) chips.push(`<span class="chip">Tipo: ${c.tipo}</span>`); if (c.anoMin) chips.push(`<span class="chip">Ano ‚â• ${c.anoMin}</span>`); if (c.anoMax) chips.push(`<span class="chip">Ano ‚â§ ${c.anoMax}</span>`); if (c.precoMax) chips.push(`<span class="chip">At√© R$ ${Number(c.precoMax).toLocaleString('pt-BR')}</span>`); if (c.jaComprou) chips.push(`<span class="chip">‚úÖ J√° comprou</span>`); return `<div class="item"><div class="head"><div><strong>${c.nome}</strong><div class="muted">WhatsApp: ${telLimpo(c.zap)}</div><div class="chips" style="margin-top:6px">${chips.join(' ')}</div><div class="row" style="margin-top:6px"><label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" ${c.jaComprou? 'checked':''} onchange="toggleComprou(${i}, this.checked)"/> J√° comprou (n√£o enviar)</label></div></div><div class="row"><button class="btn secondary" onclick="editarCliente(${i})">Editar</button><button class="btn danger" onclick="removerCliente(${i})">Remover</button></div></div></div>`; }).join(''); renderStats(); }
    async function renderCarros(){ const box = el('#listaCarros'); const q = (el('#buscaCarro').value||'').toLowerCase().trim(); const fTipo = el('#fTipo').value; const fPreco = Number(el('#fPrecoMax').value)||null; const list = carros.filter(car=>{ const passQ = !q || car.marca?.toLowerCase().includes(q) || car.modelo?.toLowerCase().includes(q); const passT = !fTipo || car.tipo === fTipo; const passP = !fPreco || (car.preco||0) <= fPreco; return passQ && passT && passP; }); if (!list.length){ box.innerHTML = `<div class=muted>Nenhum carro no estoque.</div>`; renderStats(); return; } const htmls = await Promise.all(list.map(async (car)=>{ const interessados = clientes.map((c, cIdx)=>({c, cIdx})).filter(({c})=>compat√≠vel(c, car) && !c.jaComprou); const photos = await getPhotosByCar(car.id); const thumbs = photos.slice(0,6).map(p=>`<img class="thumb" src="${blobUrl(p.blob)}" title="${p.name}" />`).join(''); const chips = [`<span class="chip">${car.tipo}</span>`, car.ano ? `<span class="chip">Ano: ${car.ano}</span>` : '', car.preco ? `<span class="chip">R$ ${Number(car.preco).toLocaleString('pt-BR')}</span>` : '', ].join(' '); return `<div class="item"><div class="head"><div><strong>${car.marca} ${car.modelo}</strong><div class="chips" style="margin-top:6px">${chips}</div>${car.link ? `<div class="muted">üîó <a href="${car.link}" target="_blank" rel="noopener">Abrir an√∫ncio</a></div>` : ''}<div class="matches"><strong>${interessados.length}</strong> interessado(s) compat√≠veis</div></div><div class="row"><button class="btn secondary" onclick="editarCarro('${car.id}')">Editar</button><button class="btn danger" onclick="removerCarro('${car.id}')">Remover</button></div></div><div class="thumbs">${thumbs || '<span class=muted>Sem fotos</span>'}</div><div class="row" style="margin-top:8px"><label class="btn secondary" for="addFotos_${car.id}">Adicionar fotos</label><input id="addFotos_${car.id}" type="file" accept="image/*" multiple style="display:none" onchange="handleAddFotos(event, '${car.id}')" />${photos.length ? `<button class="btn secondary" onclick="gerenciarFotos('${car.id}')">Gerenciar fotos</button>`: ''}${photos.length ? `<button class="btn secondary" onclick="exportarFotosCar('${car.id}')">Exportar fotos do carro (.zip)</button>`: ''}</div><div class="row" style="margin-top:8px; flex-wrap: wrap">${interessados.map(({c})=>{ const link = waLink(c.zap, msgPadrao(car, c)); return `<a class="btn" href="${link}" target="_blank" rel="noopener">WhatsApp (texto) ‚Üí ${c.nome.split(' ')[0]}</a>`; }).join('')}</div>${interessados.length ? `${photos.length ? `<div class="row" style="margin-top:8px"><button class="btn warn" onclick="compartilharComFotos('${car.id}')">Compartilhar c/ fotos (escolha WhatsApp)</button></div>` : ''}` : ''}</div>`; })); box.innerHTML = htmls.join(''); renderStats(); }

    // ====== CRUD Clientes ======
    let editClienteIdx = null;
    function resetClienteForm(){ el('#cliNome').value=''; el('#cliZap').value=''; el('#cliMarca').value=''; el('#cliModelo').value=''; el('#cliTipo').value=''; el('#cliAnoMin').value=''; el('#cliAnoMax').value=''; el('#cliPrecoMax').value=''; const jc = document.getElementById('cliJaComprou'); if (jc) jc.checked = false; editClienteIdx=null; el('#btnAddCliente').textContent='Salvar cliente'; }
    function salvarCliente(){ const c={ nome: el('#cliNome').value.trim(), zap: el('#cliZap').value.trim(), marca: el('#cliMarca').value.trim(), modelo: el('#cliModelo').value.trim(), tipo: el('#cliTipo').value, anoMin: numOrNull(el('#cliAnoMin').value), anoMax: numOrNull(el('#cliAnoMax').value), precoMax: numOrNull(el('#cliPrecoMax').value), jaComprou: !!(document.getElementById('cliJaComprou')?.checked) }; if (!c.nome || !c.zap) { alert('Informe nome e WhatsApp.'); return; } if (!validaZapBR(c.zap)) { alert('WhatsApp inv√°lido. Formato: 55 + DDD + n√∫mero.'); return; } const idxDup = clienteDuplicado(c.zap); if (idxDup >= 0 && idxDup !== editClienteIdx) { if (!confirm('J√° existe um cliente com esse WhatsApp. Deseja substituir?')) return; clientes[idxDup] = c; write(KEYS.clientes, clientes); resetClienteForm(); renderClientes(); renderCarros(); return; } if (editClienteIdx !== null) clientes[editClienteIdx]=c; else clientes.push(c); write(KEYS.clientes, clientes); resetClienteForm(); renderClientes(); renderCarros(); }
    function editarCliente(idx){ const c=clientes[idx]; editClienteIdx=idx; el('#cliNome').value=c.nome||''; el('#cliZap').value=c.zap||''; el('#cliMarca').value=c.marca||''; el('#cliModelo').value=c.modelo||''; el('#cliTipo').value=c.tipo||''; el('#cliAnoMin').value=c.anoMin??''; el('#cliAnoMax').value=c.anoMax??''; el('#cliPrecoMax').value=c.precoMax??''; const jc = document.getElementById('cliJaComprou'); if (jc) jc.checked = !!c.jaComprou; el('#btnAddCliente').textContent='Atualizar cliente'; window.scrollTo({top:0, behavior:'smooth'}); }
    function removerCliente(idx){ if (!confirm('Remover este cliente?')) return; clientes.splice(idx,1); write(KEYS.clientes, clientes); renderClientes(); renderCarros(); }
    function toggleComprou(idx, val){ clientes[idx].jaComprou = !!val; write(KEYS.clientes, clientes); renderClientes(); renderCarros(); }

    // ====== CRUD Carros ======
    let editCarroId = null;
    function resetCarroForm(){ el('#carMarca').value=''; el('#carModelo').value=''; el('#carTipo').value='Sedan'; el('#carAno').value=''; el('#carPreco').value=''; el('#carLink').value=''; el('#carFotos').value=''; editCarroId=null; el('#btnAddCarro').textContent='Salvar carro'; }
    async function salvarCarro(){ const novo = { id: editCarroId || uuid(), marca: el('#carMarca').value.trim(), modelo: el('#carModelo').value.trim(), tipo: el('#carTipo').value, ano: numOrNull(el('#carAno').value), preco: numOrNull(el('#carPreco').value), link: el('#carLink').value.trim(), }; if (!novo.marca || !novo.modelo) { alert('Informe marca e modelo.'); return; } const dup = carroDuplicado(novo); if (dup >= 0 && carros[dup].id !== novo.id){ if (!confirm('Carro possivelmente duplicado (mesma marca/modelo/ano/pre√ßo). Continuar mesmo assim?')) return; } if (editCarroId){ const i = carros.findIndex(c=>c.id===editCarroId); if (i>=0) carros[i]=novo; else carros.push(novo); } else { carros.push(novo); } write(KEYS.carros, carros); const files = el('#carFotos').files; if (files && files.length){ await addPhotos(novo.id, Array.from(files).slice(0,10)); } resetCarroForm(); renderCarros(); }
    async function editarCarro(id){ const car = carros.find(c=>c.id===id); if (!car) return; editCarroId = id; el('#carMarca').value=car.marca||''; el('#carModelo').value=car.modelo||''; el('#carTipo').value=car.tipo||'Sedan'; el('#carAno').value=car.ano??''; el('#carPreco').value=car.preco??''; el('#carLink').value=car.link||''; el('#btnAddCarro').textContent='Atualizar carro'; window.scrollTo({top:0, behavior:'smooth'}); }
    function removerCarro(id){ if (!confirm('Remover este carro? As fotos permanecem at√© voc√™ limpar o banco de fotos.')) return; carros = carros.filter(c=>c.id!==id); write(KEYS.carros, carros); renderCarros(); }
    async function handleAddFotos(e, carId){ const files = e.target.files; if (!files?.length) return; await addPhotos(carId, files); renderCarros(); e.target.value=''; }
    async function gerenciarFotos(carId){ const photos = await getPhotosByCar(carId); if (!photos.length){ alert('Este carro n√£o tem fotos.'); return; } const names = photos.map((p,i)=>`${i+1}) ${p.name} (${Math.round(p.size/1024)} KB)`).join('\n'); const idx = prompt(`Fotos deste carro:\n${names}\n\nDigite o n√∫mero da foto para remover (ou vazio p/ cancelar):`); const n = Number(idx); if (!Number.isFinite(n) || n<1 || n>photos.length) return; const alvo = photos[n-1]; if (confirm(`Remover a foto: ${alvo.name}?`)){ await deletePhoto(alvo.id); alert('Foto removida.'); renderCarros(); } }

    // ====== Envio WhatsApp ======
    async function compartilharComFotos(carId){ const car = carros.find(c=>c.id===carId); if (!car) return; const photos = await getPhotosByCar(carId); if (!photos.length){ alert('Este carro n√£o tem fotos.'); return; } if (!navigator.share){ alert('Compartilhamento nativo n√£o dispon√≠vel neste dispositivo/navegador. Use o bot√£o "WhatsApp (texto)" e anexe as fotos manualmente.'); return; } const files = photos.slice(0,10).map(p=> new File([p.blob], p.name, {type:p.type}) ); const text = `*${car.marca} ${car.modelo}* ${car.ano?('- '+car.ano):''}${car.preco?(' - R$ '+Number(car.preco).toLocaleString('pt-BR')):''}${car.link?('\n'+car.link):''}`; const payload = { text, files }; if (navigator.canShare && !navigator.canShare({files})) delete payload.files; try { await navigator.share(payload); } catch(err){ /* cancelado */ } }

    // ====== Backup Excel & Fotos ======
    function baixarBlob(nome, blob){ const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=nome; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    function exportarExcel(){ const clientesRows = clientes.map(c=>({ 'Nome': c.nome || '', 'WhatsApp': telLimpo(c.zap || ''), 'Marca': c.marca || '', 'Modelo': c.modelo || '', 'Tipo': c.tipo || '', 'AnoMin': c.anoMin ?? '', 'AnoMax': c.anoMax ?? '', 'PrecoMax': c.precoMax ?? '', 'JaComprou': c.jaComprou ? 1 : 0 })); const carrosRows = carros.map(car=>({ 'ID': car.id, 'Marca': car.marca || '', 'Modelo': car.modelo || '', 'Tipo': car.tipo || '', 'Ano': car.ano ?? '', 'Preco': car.preco ?? '', 'Link': car.link || '' })); const wb = XLSX.utils.book_new(); const wsClientes = XLSX.utils.json_to_sheet(clientesRows, {header:['Nome','WhatsApp','Marca','Modelo','Tipo','AnoMin','AnoMax','PrecoMax','JaComprou']}); const wsCarros = XLSX.utils.json_to_sheet(carrosRows, {header:['ID','Marca','Modelo','Tipo','Ano','Preco','Link']}); XLSX.utils.book_append_sheet(wb, wsClientes, 'Clientes'); XLSX.utils.book_append_sheet(wb, wsCarros, 'Carros'); XLSX.writeFile(wb, `backup_loja_carros_${nowTS()}.xlsx`); }
    function importarExcel(file){ const reader = new FileReader(); reader.onload = (e)=>{ try{ const data = new Uint8Array(e.target.result); const wb = XLSX.read(data, {type:'array'}); let impC=0, impCar=0, dropC=0, dropCar=0; if (wb.Sheets['Clientes']){ const rows = XLSX.utils.sheet_to_json(wb.Sheets['Clientes'], {defval:''}); const arr = rows.map(r=>({ nome: String(r['Nome'] ?? '').trim(), zap: String(r['WhatsApp'] ?? '').trim(), marca: String(r['Marca'] ?? '').trim(), modelo: String(r['Modelo'] ?? '').trim(), tipo: String(r['Tipo'] ?? '').trim(), anoMin: r['AnoMin']!=='' ? Number(r['AnoMin']) : null, anoMax: r['AnoMax']!=='' ? Number(r['AnoMax']) : null, precoMax: r['PrecoMax']!=='' ? Number(r['PrecoMax']) : null, jaComprou: toBool(r['JaComprou'] || '') })); clientes = []; for (const c of arr){ if (c.nome && c.zap && validaZapBR(c.zap)) { clientes.push(c); impC++; } else { dropC++; } } write(KEYS.clientes, clientes); } if (wb.Sheets['Carros']){ const rows = XLSX.utils.sheet_to_json(wb.Sheets['Carros'], {defval:''}); const arr = rows.map(r=>({ id: String(r['ID']||'').trim() || uuid(), marca: String(r['Marca'] ?? '').trim(), modelo: String(r['Modelo'] ?? '').trim(), tipo: String(r['Tipo'] ?? '').trim(), ano: r['Ano']!=='' ? Number(r['Ano']) : null, preco: r['Preco']!=='' ? Number(r['Preco']) : null, link: String(r['Link'] ?? '').trim(), })); carros = []; for (const car of arr){ if (car.marca && car.modelo){ carros.push(car); impCar++; } else { dropCar++; } } write(KEYS.carros, carros); } renderClientes(); renderCarros(); alert(`Importa√ß√£o conclu√≠da.\nClientes: ${impC} ok, ${dropC} ignorados.\nCarros: ${impCar} ok, ${dropCar} ignorados.`); }catch(err){ console.error(err); alert('Falha ao importar o Excel. Verifique abas e colunas.'); } }; reader.readAsArrayBuffer(file); }
    async function exportarFotosZip(){ const zip = new JSZip(); const folder = zip.folder('fotos'); for (const car of carros){ const photos = await getPhotosByCar(car.id); if (!photos.length) continue; const dir = folder.folder(car.id); for (const p of photos){ dir.file(p.name, p.blob); } } const blob = await zip.generateAsync({type:'blob'}); baixarBlob(`fotos_${nowTS()}.zip`, blob); }
    async function exportarFotosCar(carId){ const car = carros.find(c=>c.id===carId); if (!car) return; const photos = await getPhotosByCar(carId); if (!photos.length){ alert('Sem fotos para este carro.'); return; } const zip = new JSZip(); const dir = zip.folder(`fotos/${car.id}`); for (const p of photos){ dir.file(p.name, p.blob); } const blob = await zip.generateAsync({type:'blob'}); baixarBlob(`fotos_${car.marca}_${car.modelo}_${nowTS()}.zip`, blob); }
    async function importarFotosZip(file){ const zip = await JSZip.loadAsync(file); let ok=0, skip=0; const tasks = []; zip.forEach((path, entry)=>{ if (entry.dir) return; const parts = path.split('/'); if (parts.length < 3 || parts[0] !== 'fotos') { skip++; return; } const carId = parts[1]; if (!carros.find(c=>c.id===carId)) { skip++; return; } tasks.push(entry.async('blob').then(blob=>{ const recFile = new File([blob], parts.slice(2).join('_') || 'foto.jpg', {type: blob.type||'image/jpeg'}); return addPhotos(carId, [recFile]).then(()=> ok++); })); }); await Promise.all(tasks); alert(`Importa√ß√£o de fotos: ${ok} adicionadas, ${skip} ignoradas.`); renderCarros(); }

    // ====== Listeners ======
    document.getElementById('btnAddCliente').addEventListener('click', salvarCliente);
    document.getElementById('btnLimparCliente').addEventListener('click', resetClienteForm);
    document.getElementById('btnApagarClientes').addEventListener('click', ()=>{ if (!confirm('Apagar TODOS os clientes?')) return; clientes=[]; write(KEYS.clientes, clientes); renderClientes(); renderCarros(); });
    document.getElementById('btnAddCarro').addEventListener('click', salvarCarro);
    document.getElementById('btnLimparCarro').addEventListener('click', resetCarroForm);
    document.getElementById('btnApagarCarros').addEventListener('click', ()=>{ if (!confirm('Apagar TODOS os carros?')) return; carros=[]; write(KEYS.carros, carros); renderCarros(); });
    document.getElementById('buscaCliente').addEventListener('input', renderClientes);
    document.getElementById('buscaCarro').addEventListener('input', renderCarros);
    document.getElementById('fTipo').addEventListener('change', renderCarros);
    document.getElementById('fPrecoMax').addEventListener('input', renderCarros);
    document.getElementById('btnExportExcel').addEventListener('click', exportarExcel);
    document.getElementById('impExcel').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if (!f) return; importarExcel(f); e.target.value=''; });
    document.getElementById('btnZipFotos').addEventListener('click', exportarFotosZip);
    document.getElementById('impZipFotos').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if (!f) return; importarFotosZip(f); e.target.value=''; });
    bindAccountUI();

    // ====== Boot ======
    (async function(){ await db(); await initAuthUI(); renderClientes(); renderCarros(); })();
  </script>
</body>
</html>
